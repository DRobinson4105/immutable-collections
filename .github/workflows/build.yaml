name: build

on: [push]

jobs:
  build-and-test:

    runs-on: ubuntu-latest

    steps:
      - name: "checkout"
        uses: actions/checkout@v1

      - name: "get buildTools"
        uses: ModelingValueGroup/buildTools@master
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "setup JDK"
        uses: actions/setup-java@v1
        with:
          java-version: 11

      - name: "install packages for building"
        run: sudo apt-get install xmlstarlet jq maven

      - name: "prepare ant"
        run:  |
          cat <<EOF >build.properties
          jdk.home.11=$JAVA_HOME
          path.variable.maven_repository=~/.m2/repository
          EOF

      - name: "(re)generate sources"
        run:  |
          build/postProcessAntFiles.sh
          ant compile.module.build
          java -cp out/production/build EolCorrector
          java -cp out/production/build HeaderGenerator
          java -cp out/production/build StructGenerator

      - name: "push changes back"
        run:  |
          set -x
          if [[ -f changes-detected ]]; then
            git config user.email "automation@modelingvalue.com"
            git config user.name "github automation user"
            git add .
            git commit -m "push back regenerated files @$(date)"
            git push "HEAD:${GITHUB_REF#refs/heads/}"
          fi

      - name: "get dependencies (as in pom)"
        run:  |
          . buildTools.sh
          mkdir -p lib
          mvn_ ${{ secrets.GITHUB_TOKEN }} dependency:copy-dependencies -DoutputDirectory=lib

      - name: "forced stop"
        run:  exit 99
